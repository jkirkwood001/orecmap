<!DOCTYPE html>
<html>
<head>
    <title>Map with Glide Table Pins</title>
    <style>
        #map {
            height: 550px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>

    <script type="module">
        import * as glide from "https://cdn.skypack.dev/@glideapps/tables";

        const addressesTable = glide.table({
            token: "4c8dde9f-896c-41fe-8fc2-7cf292e0cf61",
            app: "AaC2jhlDbFkyHaGUQr24",
            table: "native-table-fEIWIJDP168Lk1NKrizd",
            columns: {
                id: { type: "row-id", name: "id" },
                address: { type: "string", name: "Address" },
                lat: { type: "number", name: "Lat" },
                lng: { type: "number", name: "Lng" }
            }
        });

        let map;
        let markers = [];

        function getCoordinatesFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get("lat"));
            const lng = parseFloat(urlParams.get("lng"));
            return (!isNaN(lat) && !isNaN(lng)) ? { lat, lng } : { lat: 45.423, lng: -75.700 };
        }

        function initMap() {
            const center = getCoordinatesFromURL();
            const zoom = 14;

            map = new google.maps.Map(document.getElementById("map"), {
                center: center,
                zoom: zoom,
                mapTypeId: "hybrid"
            });

            loadPinsFromGlideTable(map);
        }

        async function loadPinsFromGlideTable(map) {
            try {
                const rows = await addressesTable.get();
                rows.forEach(row => {
                    if (!row.lat || !row.lng) return;
                    const lat = parseFloat(row.lat);
                    const lng = parseFloat(row.lng);
                    const label = row.address || "No Address";
                    addMarker({ lat, lng }, label, map);
                });
            } catch (error) {
                console.error("Failed to load from Glide Table:", error);
            }
        }

        function addMarker(location, label, map) {
            const marker = new google.maps.Marker({
                position: location,
                map: map,
                title: label
            });

            const infowindow = new google.maps.InfoWindow({
                content: `<strong>${label}</strong><br>Lat: ${location.lat}<br>Lng: ${location.lng}`
            });

            marker.addListener("click", function () {
                markers.forEach(m => m.infowindow?.close());
                infowindow.open(map, marker);
            });

            marker.infowindow = infowindow;
            markers.push(marker);
        }

        window.initMap = initMap;
    </script>

    <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyArphrYz6SOfecninN0rVP5NS0unaArAlY&callback=initMap"></script>
</body>
</html>
