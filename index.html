<!DOCTYPE html>
<html>
  <head>
    <title>Custom Google Map with Marker Clustering</title>

    <script>
      // Replace with your deployed Apps Script endpoint
      const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbx87euepoIJU8AG62deU6j9GM330m5yY6VH5bP791cEKUUjc6D2v7ms2HfzawsfVKt_/exec";

      function getZoomFromURL() {
        const params = new URLSearchParams(window.location.search);
        return parseInt(params.get("zoom")) || 10;
      }

      function getLatFromURL() {
        const params = new URLSearchParams(window.location.search);
        return parseFloat(params.get("lat")) || 45.4215;
      }

      function getLngFromURL() {
        const params = new URLSearchParams(window.location.search);
        return parseFloat(params.get("lng")) || -75.6993;
      }

      function getEmailFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("email") || "";
      }

      function isReadOnlyFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("readonly") === "true";
      }

      let map;
      let infoWindow;
      let userMarker;

      window.initMap = async function () {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: getLatFromURL(), lng: getLngFromURL() },
          zoom: getZoomFromURL(),
        });

        infoWindow = new google.maps.InfoWindow();

        try {
          const response = await fetch(SHEET_API_URL);
          const data = await response.json();

          const markers = data.map((row) => {
            const marker = new google.maps.Marker({
              position: { lat: parseFloat(row.lat), lng: parseFloat(row.lng) },
              title: row.address,
            });

            marker.addListener("click", () => {
              infoWindow.setContent(`<strong>${row.address}</strong>`);
              infoWindow.open(map, marker);
            });

            return marker;
          });

          new markerClusterer.MarkerClusterer({ map, markers });
        } catch (err) {
          console.error("Error fetching marker data:", err);
        }

        if (!isReadOnlyFromURL()) {
          map.addListener("click", async (e) => {
            if (userMarker) userMarker.setMap(null);

            userMarker = new google.maps.AdvancedMarkerElement({
              position: e.latLng,
              map: map,
              title: "Your Pin",
            });

            const address = prompt("Enter a description or address for this pin:");

            if (address) {
              try {
                await fetch(SHEET_API_URL, {
                  method: "POST",
                  headers: { "Content-Type": "application/json" },
                  body: JSON.stringify({
                    address: address,
                    lat: e.latLng.lat(),
                    lng: e.latLng.lng(),
                  }),
                });
              } catch (err) {
                console.error("Error posting new marker:", err);
              }
            }
          });
        }
      };
    </script>

    <!-- MarkerClusterer and Google Maps API -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVTKDaMKijXNaqf2PbL0USscRNCox2AfQ&callback=initMap&loading=async&libraries=marker" async></script>

    <style>
      html,
      body,
      #map {
        height: 100%;
        margin: 0;
        padding: 0;
      }
    </style>
  </head>

  <body>
    <div id="map"></div>
  </body>
</html>
