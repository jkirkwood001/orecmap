<!DOCTYPE html>
<html>
<head>
    <title>Map with Pin Drop Functionality</title>
    <style>
        #map {
            height: 550px;
            width: 100%;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <script>
        var map;
        var markers = [];
        var webhookURL = 'https://hooks.zapier.com/hooks/catch/2177604/2f5w5ol/';

        // Function to extract latitude and longitude from the URL or use default
        function getCoordinatesFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const lat = parseFloat(urlParams.get("lat"));
            const lng = parseFloat(urlParams.get("lng"));

            // If valid coordinates are provided, use them; otherwise, return the default
            if (!isNaN(lat) && !isNaN(lng)) {
                return { lat: lat, lng: lng };
            }
            // Default coordinates
            return { lat: 45.423, lng: -75.700 };
        }

        // Function to extract zoom from the URL or use default
        function getZoomFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const zoom = parseFloat(urlParams.get("zoom"));

            // If valid zoom is provided, use it; otherwise, return the default
            if (!isNaN(zoom)) {
                return zoom;
            }
            return 14;  // Default zoom level
        }

        // Function to extract user ID from the URL or return null if not provided
        function getUserIDfromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const userID = urlParams.get("userID");
            return userID ? userID : null;  // Return null if no user ID is found
        }

        // Function to extract the readOnly flag from the URL
        function getReadOnlyFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const readOnly = urlParams.get("readOnly");

            // If "readOnly" is "true", return true; otherwise, return false
            return readOnly === "true";
        }

        // Initialize the map
        function initMap() {
            var mapCenter = getCoordinatesFromURL();  // Use URL coordinates or default
            var mapZoom = getZoomFromURL();  // Use URL zoom or default
            var mapUserID = getUserIDfromURL();  // Get the user ID from the URL
            var isReadOnly = getReadOnlyFromURL();  // Check if the map should be read-only

            map = new google.maps.Map(document.getElementById('map'), {
                zoom: mapZoom,
                center: mapCenter,
                mapTypeId: 'hybrid',
                streetViewControl: true,
                mapTypeControl: true,
                tilt: 0,
                styles: []
            });

            // Only send starting coordinates if the map is not read-only
            if (!isReadOnly) {
                fetch(webhookURL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        lat: mapCenter.lat,
                        lng: mapCenter.lng,
                        userID: mapUserID
                    })
                })
                .then(() => console.log("Starting coordinates sent to webhook"))
                .catch(error => console.error("Error sending starting coordinates:", error));
            }

            map.addListener('click', function (event) {
                addMarker(event.latLng, mapUserID, isReadOnly);
            });
        }

        // Add a marker to the map and send its coordinates (only if not read-only)
        function addMarker(location, userID, isReadOnly) {
            clearMarkers();
            var marker = new google.maps.Marker({
                position: location,
                map: map
            });
            markers.push(marker);

            var infowindowContent = 'Latitude: ' + location.lat() + '<br>Longitude: ' + location.lng();
            var infowindow = new google.maps.InfoWindow({
                content: infowindowContent
            });
            infowindow.open(map, marker);

            // Only send marker coordinates if the map is not read-only
            if (!isReadOnly) {
                fetch(webhookURL, {
                    method: "POST",
                    mode: "no-cors",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        lat: location.lat(),
                        lng: location.lng(),
                        userID: userID
                    })
                })
                .then(() => console.log("Marker coordinates sent to webhook"))
                .catch(error => console.error("Error sending marker coordinates:", error));
            }
        }

        // Clear all markers from the map
        function clearMarkers() {
            markers.forEach(marker => marker.setMap(null));
            markers = [];
        }
    </script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyArphrYz6SOfecninN0rVP5NS0unaArAlY&callback=initMap" async defer></script>
</body>
</html>
