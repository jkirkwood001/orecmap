<!DOCTYPE html>
<html>
  <head>
    <title>Map Integration</title>
    <!-- Updated Google Maps script with loading=async -->
    <script
      src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCVTKDaMKijXNaqf2PbL0USscRNCox2AfQ&callback=initMap&loading=async"
      async
    ></script>
    <!-- Updated MarkerClusterer script -->
    <script src="https://unpkg.com/@googlemaps/markerclusterer/dist/index.min.js"></script>
    <style>
      #map {
        height: 100vh;
        width: 100%;
      }
    </style>
  </head>
  <body>
    <div id="map"></div>

    <script>
      function getZoomFromURL() {
        const params = new URLSearchParams(window.location.search);
        return parseInt(params.get("zoom")) || 10;
      }

      function getLatFromURL() {
        const params = new URLSearchParams(window.location.search);
        return parseFloat(params.get("lat")) || 45.4215;
      }

      function getLngFromURL() {
        const params = new URLSearchParams(window.location.search);
        return parseFloat(params.get("lng")) || -75.6993;
      }

      function getEmailFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("email") || "";
      }

      function isReadOnlyFromURL() {
        const params = new URLSearchParams(window.location.search);
        return params.get("readonly") === "true";
      }

      let map;
      let infoWindow;
      let userMarker;

      const SHEET_URL = "https://opensheet.elk.sh/1S3ozfJcm3Ok8oyC5IXsXKOU6a1yIG4mwV3YwIRqnK-4/100_Addresses";
      const ZAP_URL = "https://hooks.zapier.com/hooks/catch/15857292/3z9s1mf/";

      // ✅ Ensure initMap is globally accessible
      window.initMap = async function () {
        map = new google.maps.Map(document.getElementById("map"), {
          center: { lat: getLatFromURL(), lng: getLngFromURL() },
          zoom: getZoomFromURL(),
        });

        infoWindow = new google.maps.InfoWindow();

        const response = await fetch(SHEET_URL);
        const data = await response.json();

        const markers = data.map((row) => {
          const marker = new google.maps.Marker({
            position: {
              lat: parseFloat(row.lat),
              lng: parseFloat(row.lng),
            },
            title: row.title,
          });

          marker.addListener("click", () => {
            infoWindow.setContent(
              `<div><strong>${row.title}</strong><br>${row.description}</div>`
            );
            infoWindow.open(map, marker);
          });

          return marker;
        });

        // ✅ Use updated marker clusterer
        new markerClusterer.MarkerClusterer({ map, markers });

        if (!isReadOnlyFromURL()) {
          map.addListener("click", (e) => {
            if (userMarker) userMarker.setMap(null);

            userMarker = new google.maps.Marker({
              position: e.latLng,
              map: map,
              title: "Your Location",
            });

            const email = getEmailFromURL();
            if (email) {
              fetch(ZAP_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                  lat: e.latLng.lat(),
                  lng: e.latLng.lng(),
                  email: email,
                }),
              });
            }
          });
        }
      };
    </script>
  </body>
</html>
