// Initialize the map
function initMap() {
    var mapCenter = getCoordinatesFromURL();  // Use URL coordinates or default
    var mapZoom = getZoomFromURL();  // Use URL zoom or default
    var isReadOnly = getReadOnlyFromURL();  // Check if the map should be read-only
    var showPin = shouldShowPin();  // Check if the initial pin should be displayed

    map = new google.maps.Map(document.getElementById('map'), {
        zoom: mapZoom,
        center: mapCenter,
        mapTypeId: 'hybrid',
        streetViewControl: true,
        mapTypeControl: true,
        tilt: 0,
        styles: []
    });

    // Add a pin at the initial location if showPin=true, but do NOT send to webhook
    if (showPin) {
        addMarkerWithoutPost(mapCenter);  // Add marker without posting
    }

    // Add a marker and send coordinates when the user clicks on the map
    map.addListener('click', function (event) {
        addMarker(event.latLng, isReadOnly);  // Add marker and post data
    });
}

// Add a marker without sending to the webhook
function addMarkerWithoutPost(location) {
    clearMarkers();
    var marker = new google.maps.Marker({
        position: location,
        map: map
    });
    markers.push(marker);

    var infowindowContent = 'Latitude: ' + location.lat + '<br>Longitude: ' + location.lng;
    var infowindow = new google.maps.InfoWindow({
        content: infowindowContent
    });
    infowindow.open(map, marker);
}

// Add a marker to the map and send its coordinates (only if not read-only)
function addMarker(location, isReadOnly) {
    clearMarkers();
    var marker = new google.maps.Marker({
        position: location,
        map: map
    });
    markers.push(marker);

    var infowindowContent = 'Latitude: ' + location.lat() + '<br>Longitude: ' + location.lng();
    var infowindow = new google.maps.InfoWindow({
        content: infowindowContent
    });
    infowindow.open(map, marker);

    // Only send marker coordinates if the map is not read-only
    if (!isReadOnly) {
        fetch(webhookURL, {
            method: "POST",
            mode: "no-cors",
            headers: {
                "Content-Type": "application/json"
            },
            body: JSON.stringify({
                lat: location.lat(),
                lng: location.lng()
            })
        })
        .then(() => console.log("Marker coordinates sent to webhook"))
        .catch(error => console.error("Error sending marker coordinates:", error));
    } else {
        console.log("Map is in read-only mode. Marker added but not sent to webhook.");
    }
}
